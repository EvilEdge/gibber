<!DOCTYPE html><html lang="en"><head><title>sequence</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="sequence"><meta name="groc-project-path" content="sequence.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">sequence.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="-gibber-sequencejs"> Gibber - sequence.js</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="seq">Seq</h3>

<p>Create a sequencer object, the base class for all sequencing capabilities in Gibber</p>

<p>param <strong>values</strong>: Array or function. The value(s) to be sequenced.
param <strong>duration</strong> : Array or Gibber time value. The length for each value in the sequence. This can either be a single Gibber time value or an array of Gibber time values.</p>

<p>example usage: <br />
<code>s = Synth(); <br />
 t = Seq(["C4", "D4", "G4", "F4"], [_2, _8, _4, _4 * 1.5]).slave(s);</code></p>

<p>alternatively: <br />
<code>s = Synth(); <br />
 t = Seq(["C4", "D4", "G4", "F4"], _4).slave(s)</code> </p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">Seq</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">_seq</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">_seq</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// wrap anonymous function in array as sugar</span>
    <span class="nx">_seq</span> <span class="o">=</span> <span class="p">[</span><span class="nx">_seq</span><span class="p">];</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">arg1Type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">durations</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">arg1Type</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arg1Type</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">speed</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">durations</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">speed</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">durations</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nx">speed</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">window</span><span class="p">[</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">]</span> <span class="o">:</span> <span class="nx">_4</span><span class="p">;</span>
    <span class="nx">durations</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">_outputMsg</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  
  <span class="k">if</span><span class="p">(</span><span class="nx">_outputMsg</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_outputMsg</span> <span class="o">=</span> <span class="s2">&quot;note&quot;</span><span class="p">;</span>
  <span class="p">}</span>
    
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">:</span> <span class="s2">&quot;Seq&quot;</span><span class="p">,</span>
    <span class="nx">type</span> <span class="o">:</span> <span class="s2">&quot;control&quot;</span><span class="p">,</span>
    <span class="nx">_sequence</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">sequence</span> <span class="o">:</span> <span class="nx">_seq</span><span class="p">,</span>
    <span class="nx">_start</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">offset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">// used to sequence Gibber object</span>
    <span class="nx">counter</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// position in seqeuence</span>
    <span class="nx">_counter</span> <span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="c1">// used for scheduling</span>
    <span class="nx">speed</span><span class="o">:</span> <span class="nx">speed</span><span class="p">,</span>
    <span class="nx">durations</span> <span class="o">:</span> <span class="nx">durations</span><span class="p">,</span>
    <span class="nx">outputMessage</span><span class="o">:</span><span class="nx">_outputMsg</span><span class="p">,</span>
    <span class="nx">active</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span>
    <span class="nx">slaves</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">phase</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">memory</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">mods</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">shouldDie</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">oddEven</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">phaseOffset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="once">once</h4>

<p>Play the sequence once and then end it</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="nx">that</span><span class="p">.</span><span class="nx">schedule</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="kill">kill</h4>

<p>Destroy the sequencer</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">kill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">free</span><span class="p">();</span>
    <span class="nx">Gibber</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">slave</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">slave</span><span class="p">.</span><span class="nx">masters</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">mods</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
  <span class="p">},</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="setsequence">setSequence</h4>

<p>assign a new set of values to be sequenced</p>

<p>param <strong>seq</strong> Array or Function. The new values to be sequenced <br />
param <strong><em>speed</strong> Int. Optional. A new speed for the sequencer to run at <br />
param <strong></em>reset</strong> Bool. Optional. If true, reset the the current position of the sequencer to 0.  </p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">setSequence</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">seq</span><span class="p">,</span> <span class="nx">_speed</span><span class="p">,</span> <span class="nx">_reset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">_speed</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="nx">_speed</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nx">_reset</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   
      <span class="k">this</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">=</span> <span class="p">[];</span>
    
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">seq</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">seq</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_c</span> <span class="o">=</span> <span class="nx">seq</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_c</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">seq</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">seq</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;CALLING INIT&quot;</span><span class="p">);</span>
      <span class="nx">Gibber</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_sequence</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="slave">slave</h4>

<p>assign a new set of values to be sequenced</p>

<p>param <strong>seq</strong> Comma separated list of generators. The generators to be controlled by this sequencer  </p>

<p>example:
<code>s = Synth(); <br />
ss = Synth(); <br />
t = Seq(["C4", "D4"], _1) <br />
t.slave(s, ss);</code></p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">slave</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  
      <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">inArray</span><span class="p">(</span> <span class="nx">gen</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">idx</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">gen</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">masters</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">gen</span><span class="p">.</span><span class="nx">masters</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">];</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="nx">gen</span><span class="p">.</span><span class="nx">masters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">note</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">outputMessage</span> <span class="o">==</span> <span class="s2">&quot;note&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">outputMessage</span> <span class="o">=</span> <span class="s2">&quot;freq&quot;</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>    
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="free">free</h4>

<p>stop controlling slaved ugens</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">free</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="stop">stop</h4>

<p>stop the sequencer from running and reset the position to 0</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   
    <span class="k">this</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="pause">pause</h4>

<p>stop the sequencer from running but do not reset the current position</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="play">play</h4>

<p>start the sequencer running</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">play</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="advance">advance</h4>

<p>run the current event and schedule the next one. This is called automatically by the master clock if a sequencer is added to the Gibber.callback.slaves array.</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">advance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">counter</span> <span class="o">%</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">[</span><span class="nx">pos</span><span class="p">];</span>
    
      <span class="kd">var</span> <span class="nx">shouldReturn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Function sequencing
TODO: there should probably be a more robust way to to this
but it will look super nice and clean on screen...</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">durations</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">G</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">durations</span><span class="p">[</span><span class="nx">pos</span><span class="p">]),</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="nx">G</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">),</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
        
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>     
      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_slave</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">slaves</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
  
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outputMessage</span> <span class="o">===</span> <span class="s2">&quot;freq&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">nt</span> <span class="o">=</span> <span class="nx">teoria</span><span class="p">.</span><span class="nx">note</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">nt</span><span class="p">.</span><span class="nx">fq</span><span class="p">();</span>
          <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">){</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">fq</span><span class="p">();</span>
          <span class="p">}</span><span class="c1">// else val is a number and is fine to send as a freq...</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">_slave</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">outputMessage</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_slave</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">outputMessage</span><span class="p">](</span><span class="nx">val</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="nx">_slave</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">outputMessage</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: should this flip-flop between floor and ceiling?</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">durations</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">G</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">durations</span><span class="p">[</span><span class="nx">pos</span><span class="p">]),</span> <span class="k">this</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">G</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">speed</span><span class="p">),</span> <span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">counter</span> <span class="o">%</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shouldDie</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
  
  <span class="nx">that</span><span class="p">.</span><span class="k">break</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newSeq</span><span class="p">,</span> <span class="nx">breakToOriginal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">shouldBreak</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
    <span class="k">if</span><span class="p">(</span><span class="nx">breakToOriginal</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">breakToOriginal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">preBreakSequence</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sequence</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">that</span><span class="p">.</span><span class="nx">getMix</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="nx">that</span><span class="p">.</span><span class="nx">out</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">generate</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="set">set</h4>

<p>assign a new set of values to be sequenced. I can't remember how this is different from setSequence, but surely there's a good reason for it :)</p>

<p>param <strong>newSequence</strong> Array or Function. The new values to be sequenced <br />
param <strong>speed</strong> Int. Optional. A new speed for the sequencer to run at <br />
param <strong>shouldReset</strong> Bool. Optional. If true, reset the the current position of the sequencer to 0.   </p></div></div><div class="code"><div class="wrapper">  
  
  <span class="nx">that</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newSequence</span><span class="p">,</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">shouldReset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">speed</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">shouldReset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">phase</span> <span class="o">-=</span> <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">-</span> <span class="nx">speed</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="nx">speed</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nx">shouldReset</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">=</span> <span class="nx">newSequence</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setSequence</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">,</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">shouldReset</span><span class="p">);</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="shuffle">shuffle</h4>

<p>randomize order of sequence</p></div></div><div class="code"><div class="wrapper">  <span class="nx">that</span><span class="p">.</span><span class="nx">shuffle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">();</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">setSequence</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">speed</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="reset">reset</h4>

<p>reset order of sequence to its original order or to a memorized set of positions</p>

<p>param <strong>memory location</strong> Int. Optional. If a sequencer has retain a order, you can recall it by passing its number here. Otherwise the sequence is reset to its original order.</p></div></div><div class="code"><div class="wrapper">  
  <span class="nx">that</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">setSequence</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">_sequence</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">speed</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">setSequence</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">memory</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
  <span class="p">};</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="retain">retain</h4>

<p>retain current order of sequenced values</p>

<p>param <strong>slotNumber</strong> Int. Optional. The position to hold the current sequencer order. By default it will simply be pushed to the memory array</p></div></div><div class="code"><div class="wrapper">  <span class="nx">that</span><span class="p">.</span><span class="nx">retain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">memory</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
  
  <span class="nx">that</span><span class="p">.</span><span class="nx">bpmCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_that</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">percentageChangeForBPM</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_that</span><span class="p">.</span><span class="nx">speed</span> <span class="o">*=</span> <span class="nx">percentageChangeForBPM</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><em>that.setSequence(</em>that.sequence, _that.speed); // don't need this, not sure why it causes errors.</p></div></div><div class="code"><div class="wrapper">    <span class="p">}</span>
  <span class="p">};</span>
  
  <span class="nx">Gibber</span><span class="p">.</span><span class="nx">registerObserver</span><span class="p">(</span> <span class="s2">&quot;bpm&quot;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">bpmCallback</span><span class="p">(</span><span class="nx">that</span><span class="p">)</span> <span class="p">);</span>
  
  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">speed</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">speed</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_that</span> <span class="o">=</span> <span class="nx">that</span><span class="p">;</span>
    
    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperties</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">{</span>
      <span class="s2">&quot;speed&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">speed</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nx">value</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="nx">speed</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setSequence</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sequence</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">})();</span>
  
  <span class="k">if</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">setSequence</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">sequence</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">speed</span><span class="p">);</span>  
  <span class="p">}</span>
  
  <span class="nx">that</span><span class="p">.</span><span class="nx">setParam</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="nx">_value</span><span class="p">){</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">param</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_value</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="nx">Gibber</span><span class="p">.</span><span class="nx">addModsAndFX</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="nx">that</span><span class="p">;</span>
<span class="p">}</span></div></div></div></div></body></html>